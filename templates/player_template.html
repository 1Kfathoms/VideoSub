<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Language Player (API Dict Version)</title>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #fff; }
        #video-container { flex: 0 0 75%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        video { max-width: 100%; max-height: 100%; }
        #error-message { display: none; color: #ff5555; background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid #ff5555; border-radius: 8px; text-align: center; z-index: 100; position: absolute; }
        #resizer { width: 8px; background: #333; cursor: col-resize; transition: background 0.2s; z-index: 10; }
        #resizer:hover, #resizer.active { background: #00FFFF; }
        #transcript-container { flex: 1; overflow-y: auto; padding: 8px; box-sizing: border-box; border-left: none; min-width: 200px; font-size: 0.95em; }
        body.resizing { cursor: col-resize; user-select: none; }
        .segment { margin-bottom: 8px; padding: 4px; border-radius: 8px; transition: background 0.2s; }
        .segment:hover { background: #2a2a2a; }
        .word { cursor: pointer; padding: 0px 2px; border-radius: 4px; transition: all 0.1s; margin-right: 1px; display: inline-block; line-height: 1.15; }
        .word:hover { background: #444; }
        .word.active { background: #00FFFF; color: #000; font-weight: inherit; }
        .translation { display: block; margin-top: 3px; color: #aaa; font-size: 0.8em; line-height: 1.25; border-left: 2px solid #555; padding-left: 5px; }
        
        /* è¾æ›¸ãƒ»æ¤œç´¢ç”¨ã®CSS */
        .dict-tooltip { position: fixed; max-width: 320px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; padding: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.5); font-size: 0.9em; line-height: 1.4; z-index: 1000; pointer-events: auto; max-height: 60vh; overflow-y: auto; }
        .dict-header { display: flex; align-items: baseline; gap: 8px; border-bottom: 1px solid #333; padding-bottom: 6px; margin-bottom: 6px; }
        .dict-word { font-weight: bold; font-size: 1.1em; color: #fff; }
        .dict-phonetic { color: #888; font-family: 'Segoe UI Symbol', sans-serif; }
        .dict-meaning-group { margin-bottom: 8px; }
        .dict-pos { display: inline-block; background: #333; color: #00FFFF; padding: 1px 4px; border-radius: 3px; font-size: 0.75em; margin-right: 6px; border: 1px solid #444; }
        .dict-def { color: #ddd; font-size: 0.9em; display: inline; }
        .speaker-btn { background: none; border: none; cursor: pointer; color: #00FFFF; font-size: 1em; padding: 0 4px; }
        .speaker-btn:hover { color: #fff; }

        #search-box { position: fixed; top: 10px; right: 10px; width: 125px; padding: 8px 12px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 0.9em; z-index: 999; }
        #search-box::placeholder { color: #888; }
        #search-box:focus { outline: none; border-color: #00FFFF; box-shadow: 0 0 6px rgba(0, 255, 255, 0.3); }
        .word.search-highlight { background: #FFB90C; color: #000; font-weight: bold; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #video-container { flex: none; width: 100%; height: 40vh; border-bottom: 2px solid #333; }
            #resizer { display: none; }
            #transcript-container { width: 100%; height: 60vh; border-left: none; padding: 8px; }
            .word { padding: 3px 5px; font-size: 1.05em; margin-bottom: 3px; }
            #search-box { position: sticky; top: 0; right: auto; width: 100%; box-sizing: border-box; margin: 0 0 8px 0; }
        }
    </style>
</head>
<body>

    <div id="video-container">
        <div id="error-message"></div>
        <video id="player" controls playsinline webkit-playsinline preload="auto"></video> 
    </div>

    <div id="resizer"></div>
    <div id="transcript-container">
        <input type="text" id="search-box" placeholder="å˜èªã‚’æ¤œç´¢...">
        <div id="content"></div>
    </div>

    <script src="data.js"></script>

    <div id="dict-tooltip" class="dict-tooltip" style="display:none;"></div>
    
    <script>
        const player = document.getElementById('player');
        const contentDiv = document.getElementById('content');
        const errorMsgDiv = document.getElementById('error-message');
        const dictTooltip = document.getElementById('dict-tooltip');
        const searchBox = document.getElementById('search-box');
        
        let resumeAfterHover = false;
        // å˜èª or ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä¸Šã«ã‚«ãƒ¼ã‚½ãƒ«ãŒä¹—ã£ã¦ã„ã‚‹æ•°
        let hoverActiveCount = 0;
        let hoverDebounceTimer = null;
        let tooltipHideTimer = null;
        let pendingWord = null;
        let dictCache = new Map(); // APIçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let allWords = []; // ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨

        // --- éŸ³å£°å†ç”Ÿæ©Ÿèƒ½ ---
        async function speakWord(text) {
            // ç°¡æ˜“TTS
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- è¾æ›¸æ©Ÿèƒ½ (APIç‰ˆ) ---
        function normalizeWord(word) {
            if (!word) return '';
            return word.trim().replace(/^[^A-Za-z0-9]+|[^A-Za-z0-9]+$/g, '');
        }

        async function fetchDefinition(word) {
            const query = normalizeWord(word);
            if (!query) return `<div class="dict-header"><span class="dict-word">${word}</span></div><span style="color:#aaa">æ¤œç´¢ä¸å¯</span>`;
            
            if (dictCache.has(query)) return dictCache.get(query);
            
            try {
                // Free Dictionary APIã‚’åˆ©ç”¨
                const resp = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(query)}`);
                
                if (!resp.ok) {
                    throw new Error('Not found');
                }

                const json = await resp.json();
                const entry = json[0]; // æœ€åˆã®çµæœã‚’ä½¿ç”¨

                // HTMLç”Ÿæˆ
                let html = `<div class="dict-header">`;
                html += `<span class="dict-word">${entry.word}</span>`;
                
                // ç™ºéŸ³è¨˜å·
                if (entry.phonetic) {
                    html += `<span class="dict-phonetic">${entry.phonetic}</span>`;
                }
                
                // éŸ³å£°å†ç”Ÿãƒœã‚¿ãƒ³
                html += `<button class="speaker-btn" onclick="speakWord('${entry.word.replace(/'/g, "\\'")}')">ğŸ”Š</button>`;
                html += `</div>`;

                // æ„å‘³ï¼ˆå“è©ã”ã¨ã«è¡¨ç¤ºï¼‰
                // APIçµæœãŒå¤šã™ãã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€æœ€å¤§3ã¤ã®æ„å‘³ã‚°ãƒ«ãƒ¼ãƒ—ã¾ã§è¡¨ç¤º
                const meaningsToShow = entry.meanings.slice(0, 3);
                
                if (meaningsToShow.length === 0) {
                    html += `<div style="color:#aaa">å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>`;
                } else {
                    meaningsToShow.forEach(m => {
                        // å®šç¾©ã‚‚å„å“è©ã«ã¤ãæœ€åˆã®1ã¤ã ã‘è¡¨ç¤ºã—ã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹
                        const def = m.definitions && m.definitions.length > 0 ? m.definitions[0].definition : '';
                        if (def) {
                            html += `<div class="dict-meaning-group">`;
                            html += `<span class="dict-pos">${m.partOfSpeech}</span>`;
                            html += `<span class="dict-def">${def}</span>`;
                            html += `</div>`;
                        }
                    });
                }
                
                dictCache.set(query, html);
                return html;

            } catch (e) {
                // ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
                const errorHtml = `<div class="dict-header"><span class="dict-word">${query}</span></div><span style="color:#aaa">è¾æ›¸å®šç¾©ãªã—</span>`;
                dictCache.set(query, errorHtml);
                return errorHtml;
            }
        }

        // --- ã‚·ãƒ¼ã‚¯æ©Ÿèƒ½ï¼ˆå®‰å…¨æ€§å‘ä¸Šç‰ˆï¼‰ ---
        function safeSeek(time) {
            if (!Number.isFinite(time)) return;
            
            // ã‚·ãƒ¼ã‚¯å¯èƒ½ç¯„å›²ã®ãƒã‚§ãƒƒã‚¯ï¼ˆpreloadã•ã‚Œã¦ã„ãªã„éƒ¨åˆ†ã¸ã®ã‚·ãƒ¼ã‚¯å¯¾ç­–ï¼‰
            let seekable = false;
            if (player.seekable && player.seekable.length > 0) {
                for (let i = 0; i < player.seekable.length; i++) {
                    if (time >= player.seekable.start(i) && time <= player.seekable.end(i)) {
                        seekable = true;
                        break;
                    }
                }
            } else {
                seekable = true; // æƒ…å ±ãŒãªã„å ´åˆã¯è©¦è¡Œã™ã‚‹
            }

            if (seekable) {
                if (player.fastSeek) {
                    player.fastSeek(time);
                } else {
                    player.currentTime = time;
                }
                if (player.paused) {
                    player.play().catch(e => console.log('Autoplay blocked:', e));
                }
            } else {
                errorMsgDiv.innerText = "èª­ã¿è¾¼ã¿å¾…ã¡ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚";
                errorMsgDiv.style.display = 'block';
                setTimeout(() => errorMsgDiv.style.display = 'none', 3000);
            }
        }

        // --- åˆæœŸåŒ– ---
        function init() {
            if (typeof MEDIA_DATA === 'undefined') {
                errorMsgDiv.innerHTML = 'data.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                errorMsgDiv.style.display = 'block';
                return;
            }

            player.src = MEDIA_DATA.videoFile;

            MEDIA_DATA.segments.forEach((segment) => {
                const segDiv = document.createElement('div');
                segDiv.className = 'segment';
                
                segment.words.forEach((w) => {
                    const span = document.createElement('span');
                    span.className = 'word';
                    span.innerText = w.word;
                    span.dataset.start = w.start;
                    span.dataset.end = w.end;
                    
                    let isClicking = false;
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    span.onclick = (e) => {
                        e.stopPropagation();
                        isClicking = true;
                        const startTime = parseFloat(span.dataset.start);
                        safeSeek(startTime);
                        setTimeout(() => { isClicking = false; }, 200);
                    };

                    // ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                    span.addEventListener('mouseenter', (ev) => {
                        if (isClicking) return;
                        if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
                        
                        // åˆå›ãƒ›ãƒãƒ¼æ™‚ã®ã¿ã€Œå…ƒã€…å†ç”Ÿä¸­ã ã£ãŸã‹ã€ã‚’è¨˜éŒ²
                        if (hoverActiveCount === 0) {
                            resumeAfterHover = !player.paused && !player.ended;
                        }
                        hoverActiveCount++;
                        if (!player.paused && !player.ended) {
                            player.pause();
                        }

                        dictTooltip.style.display = 'block';
                        dictTooltip.innerHTML = '<div class="dict-header"><span class="dict-word">Loading...</span></div>';
                        positionTooltip(ev);
                        pendingWord = w.word;

                        if (hoverDebounceTimer) clearTimeout(hoverDebounceTimer);
                        
                        // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆ150msï¼‰
                        hoverDebounceTimer = setTimeout(async () => {
                            const html = await fetchDefinition(w.word);
                            // ã¾ã åŒã˜å˜èªã‚’è¡¨ç¤ºã™ã¹ãçŠ¶æ…‹ã‹ç¢ºèª
                            if (dictTooltip.style.display === 'block' && pendingWord === w.word) {
                                dictTooltip.innerHTML = html;
                                positionTooltip(ev);
                            }
                        }, 150);
                    });

                    span.addEventListener('mouseleave', () => {
                        if (hoverDebounceTimer) clearTimeout(hoverDebounceTimer);
                        pendingWord = null;
                        
                        // ãƒ›ãƒãƒ¼å¯¾è±¡ã®æ•°ã‚’æ¸›ã‚‰ã—ã€ã‚¼ãƒ­ãªã‚‰å†ç”Ÿå†é–‹ï¼†ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ¶ˆå»
                        hoverActiveCount = Math.max(0, hoverActiveCount - 1);
                        if (hoverActiveCount === 0) {
                            if (resumeAfterHover) {
                                player.play().catch(()=>{});
                            }
                            resumeAfterHover = false;
                            tooltipHideTimer = setTimeout(() => dictTooltip.style.display = 'none', 300);
                        }
                    });
                    
                    segDiv.appendChild(span);
                });
                
                const trans = document.createElement('span');
                trans.className = 'translation';
                trans.innerText = segment.translation;
                segDiv.appendChild(trans);
                contentDiv.appendChild(segDiv);
            });
        }

        // --- è‡ªå‹•å†ç”Ÿï¼ˆã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤ï¼‰è©¦è¡Œ ---
        async function attemptAutoplay() {
            try {
                await player.play();
            } catch (e) {
                try {
                    player.muted = true;
                    await player.play();
                    // ãƒŸãƒ¥ãƒ¼ãƒˆã§å†ç”ŸãŒé–‹å§‹ã•ã‚ŒãŸå ´åˆã¯ç°¡æ˜“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
                    // errorMsgDiv.innerText = 'è‡ªå‹•å†ç”Ÿã®ãŸã‚ã€ãƒŸãƒ¥ãƒ¼ãƒˆã§å†ç”Ÿã—ã¦ã„ã¾ã™ã€‚';
                    // errorMsgDiv.style.display = 'block';
                    // setTimeout(() => errorMsgDiv.style.display = 'none', 2500);
                } catch (e2) {
                    // è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å¾…ã¤ï¼‰
                }
            }
        }

        // --- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä½ç½®è¨ˆç®— ---
        function positionTooltip(ev) {
            const margin = 12;
            let x = ev.clientX + margin;
            let y = ev.clientY + margin;
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const tooltipW = dictTooltip.offsetWidth || 320;
            const tooltipH = dictTooltip.offsetHeight || 150;

            if (x + tooltipW > vw) x = Math.max(10, ev.clientX - tooltipW - margin);
            if (y + tooltipH > vh) y = Math.max(10, ev.clientY - tooltipH - margin);

            dictTooltip.style.left = x + 'px';
            dictTooltip.style.top = y + 'px';
        }

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è‡ªä½“ã®ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¹—ã£ã¦ã„ã‚‹é–“ã¯å‹•ç”»åœæ­¢ï¼‹æ¶ˆã•ãªã„ï¼‰
        dictTooltip.addEventListener('mouseenter', () => {
            if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
            if (hoverActiveCount === 0) {
                resumeAfterHover = !player.paused && !player.ended;
            }
            hoverActiveCount++;
            if (!player.paused && !player.ended) {
                player.pause();
            }
        });
        dictTooltip.addEventListener('mouseleave', () => {
            hoverActiveCount = Math.max(0, hoverActiveCount - 1);
            if (hoverActiveCount === 0) {
                if (resumeAfterHover) {
                    player.play().catch(()=>{});
                }
                resumeAfterHover = false;
                dictTooltip.style.display = 'none';
            }
        });

        // --- ãƒªã‚µã‚¤ã‚¶ãƒ¼æ©Ÿèƒ½ ---
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('video-container');
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.body.classList.add('resizing');
            resizer.classList.add('active');
            const startX = e.clientX;
            const startWidth = leftPanel.getBoundingClientRect().width;
            const doDrag = (e) => { leftPanel.style.flex = `0 0 ${startWidth + (e.clientX - startX)}px`; };
            const stopDrag = () => {
                document.body.classList.remove('resizing');
                resizer.classList.remove('active');
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
            };
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        });

        // --- å­—å¹•ãƒã‚¤ãƒ©ã‚¤ãƒˆ & æ¤œç´¢ ---
        function cacheWords() {
            allWords = Array.from(document.querySelectorAll('.word')).map(el => ({
                el: el, start: parseFloat(el.dataset.start), end: parseFloat(el.dataset.end)
            }));
        }

        function updateHighlight() {
            const currentTime = player.currentTime;
            for (const w of allWords) {
                if (currentTime >= w.start && currentTime < w.end) {
                    if (!w.el.classList.contains('active')) {
                        w.el.classList.add('active');
                        w.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    if (w.el.classList.contains('active')) w.el.classList.remove('active');
                }
            }
            requestAnimationFrame(updateHighlight);
        }

        // æ¤œç´¢æ©Ÿèƒ½
        searchBox.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            allWords.forEach(w => {
                if (val && w.el.innerText.toLowerCase().includes(val)) {
                    w.el.classList.add('search-highlight');
                } else {
                    w.el.classList.remove('search-highlight');
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            init();
            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ç›´å¾Œã«å†ç”Ÿé–‹å§‹ã‚’è©¦ã¿ã‚‹
            attemptAutoplay();
            cacheWords();
            requestAnimationFrame(updateHighlight);
        });
    </script>
</body>
</html>