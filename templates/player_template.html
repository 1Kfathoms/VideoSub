<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Language Player (Responsive)</title>
    <style>
        /* Âü∫Êú¨Ë®≠ÂÆöÔºàPCÂêë„Åë„É¨„Ç§„Ç¢„Ç¶„Éà„Åå„Éô„Éº„ÇπÔºâ */
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #fff; }
        
        #video-container { 
            flex: 0 0 75%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #000; 
            min-width: 200px; 
        }
        video { max-width: 100%; max-height: 100%; }
        
        /* „É™„Çµ„Ç§„Ç∫Áî®„Éè„É≥„Éâ„É´ */
        #resizer {
            width: 8px;
            background: #333;
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 10;
        }
        #resizer:hover, #resizer.active {
            background: #00FFFF;
        }

        #transcript-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 8px; 
            box-sizing: border-box; 
            border-left: none; 
            min-width: 200px; 
            font-size: 0.95em; 
        }
        
        /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´ */
        body.resizing {
            cursor: col-resize;
            user-select: none;
        }

        .segment { margin-bottom: 8px; padding: 4px; border-radius: 8px; transition: background 0.2s; }
        .segment:hover { background: #2a2a2a; }
        
        .word { cursor: pointer; padding: 0px 2px; border-radius: 4px; transition: all 0.1s; margin-right: 1px; display: inline-block; line-height: 1.15; }
        .word:hover { background: #444; }
        
        .word.active { background: #00FFFF; color: #000; font-weight: inherit; }
        
        .translation { display: block; margin-top: 3px; color: #aaa; font-size: 0.8em; line-height: 1.25; border-left: 2px solid #555; padding-left: 5px; }

        /* ËæûÊõ∏„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó */
        .dict-tooltip {
            position: fixed;
            max-width: 340px;
            background: #111;
            color: #fff;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px 12px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.4);
            font-size: 0.9em;
            line-height: 1.4;
            z-index: 1000;
            pointer-events: auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Éú„Çø„É≥Áæ§ */
        .dict-tooltip-buttons {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #444;
            display: flex;
            gap: 6px;
        }

        .dict-tooltip button {
            flex: 1;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .dict-tooltip button:hover {
            background: #333;
            border-color: #00FFFF;
            color: #00FFFF;
        }

        .dict-tooltip button.marked {
            background: #00FFFF;
            color: #000;
            border-color: #00FFFF;
        }

        .speaker-btn {
            font-size: 1.1em;
        }

        /* Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ */
        #search-box {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 250px;
            padding: 8px 12px;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 0.9em;
            z-index: 999;
        }

        #search-box::placeholder {
            color: #888;
        }

        #search-box:focus {
            outline: none;
            border-color: #00FFFF;
            box-shadow: 0 0 6px rgba(0, 255, 255, 0.3);
        }

        .word.search-highlight {
            background: #FFB90C;
            color: #000;
            font-weight: bold;
        }

        /* Â≠¶Áøí„É™„Çπ„Éà„Éë„Éç„É´ */
        #study-list-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 280px;
            max-height: 300px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 12px;
            z-index: 999;
            display: none;
            overflow-y: auto;
        }

        #study-list-panel.show {
            display: block;
        }

        .study-list-header {
            color: #00FFFF;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-list-item {
            background: #222;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            border-left: 3px solid #00FFFF;
            font-size: 0.85em;
            word-break: break-all;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .study-list-item:hover {
            background: #2a2a2a;
            box-shadow: 0 2px 6px rgba(0, 255, 255, 0.3);
            transform: translateX(2px);
        }

        .study-list-item-word {
            font-weight: bold;
            color: #00FFFF;
        }

        .study-list-item-time {
            float: right;
            color: #aaa;
            font-size: 0.78em;
        }

        #study-list-clear {
            background: #333;
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s;
        }

        #study-list-clear:hover {
            background: #d00;
            color: #fff;
        }

        /* „Çπ„Éû„ÉõÂØæÂøúÁî®„É¨„Çπ„Éù„É≥„Ç∑„ÉñCSS */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #video-container {
                flex: none;
                width: 100%;
                height: 40vh;
                border-bottom: 2px solid #333;
            }

            #resizer {
                display: none;
            }

            #transcript-container {
                width: 100%;
                height: 60vh;
                border-left: none;
                padding: 8px;
            }
            
            .word {
                padding: 3px 5px;
                font-size: 1.05em; 
                margin-bottom: 3px;
            }

            #search-box {
                width: 200px;
                top: 5px;
                right: 5px;
            }

            #study-list-panel {
                width: 240px;
                max-height: 200px;
                bottom: 50px;
                right: 5px;
            }
        }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="player" controls playsinline webkit-playsinline></video> </div>

    <div id="resizer"></div>

    <div id="transcript-container">
        <div id="content"></div>
    </div>

    <input type="text" id="search-box" placeholder="ÂçòË™û„ÇíÊ§úÁ¥¢...">
    <button id="study-list-toggle" style="position:fixed;bottom:10px;left:10px;z-index:999;padding:8px 12px;background:#222;border:1px solid #444;color:#fff;border-radius:4px;cursor:pointer;">Â≠¶Áøí„É™„Çπ„Éà</button>
    <div id="study-list-panel">
        <div class="study-list-header">
            Â≠¶ÁøíÂçòË™û
            <button id="study-list-clear">„ÇØ„É™„Ç¢</button>
        </div>
        <div id="study-list-content"></div>
    </div>

    <script src="data.js"></script>
    <div id="dict-tooltip" class="dict-tooltip" style="display:none;"></div>
    
    <script>
        const player = document.getElementById('player');
        const contentDiv = document.getElementById('content');
        let resumeAfterHover = false;
        const dictTooltip = document.getElementById('dict-tooltip');
        const dictCache = new Map();
        let ejDict = null;
        let jaDict = null;
        const canLoadLocalDict = (location.protocol === 'http:' || location.protocol === 'https:');
        let hoverDebounceTimer = null;
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÊ∂à„Åô„Åü„ÇÅ„ÅÆ„Çø„Ç§„Éû„ÉºÂ§âÊï∞
        let tooltipHideTimer = null;
        let pendingWord = null;
        
        // Â≠¶Áøí„É™„Çπ„ÉàÁÆ°ÁêÜ
        const studyListStorage = 'videoSubStudyList';
        let studyList = JSON.parse(localStorage.getItem(studyListStorage)) || {};
        
        // Ê§úÁ¥¢Ê©üËÉΩ
        const searchBox = document.getElementById('search-box');
        let currentSearchQuery = '';
        let searchHighlightedWords = [];

        // ‚ñº‚ñº‚ñº Èü≥Â£∞ÂÜçÁîüÊ©üËÉΩ (Free Dictionary API) ‚ñº‚ñº‚ñº
        async function speakWord(text) {
            try {
                const query = encodeURIComponent(text.toLowerCase());
                const resp = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${query}`);
                if (!resp.ok) throw new Error('No audio found');
                
                const json = await resp.json();
                if (Array.isArray(json) && json.length > 0) {
                    const entry = json[0];
                    const phonetics = entry.phonetics || [];
                    
                    let audioUrl = null;
                    for (const phon of phonetics) {
                        if (phon.audio && phon.audio.includes('-us.mp3')) {
                            audioUrl = phon.audio;
                            break;
                        }
                    }
                    if (!audioUrl) {
                        for (const phon of phonetics) {
                            if (phon.audio) {
                                audioUrl = phon.audio;
                                break;
                            }
                        }
                    }
                    
                    if (audioUrl) {
                        const audio = new Audio(audioUrl);
                        audio.play();
                        return;
                    }
                }
            } catch (e) {
                console.log('Audio not available, falling back to Web Speech API');
            }
            
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Èü≥Â£∞ÂÜçÁîüÊ©üËÉΩ ÁµÇ‰∫Ü ‚ñ≤‚ñ≤‚ñ≤

        function usePreloadedDictsIfAny() {
            if (window.EJ_DICT_PRELOADED && !ejDict) {
                ejDict = window.EJ_DICT_PRELOADED;
            }
            if (Array.isArray(window.JA_DICT_PRELOADED) && !jaDict) {
                const map = new Map();
                window.JA_DICT_PRELOADED.forEach(obj => {
                    if (!obj || !obj.word) return;
                    const key = obj.word.trim();
                    const arr = map.get(key) || [];
                    arr.push(obj);
                    map.set(key, arr);
                });
                jaDict = map;
            }
        }

        function normalizeWord(word) {
            if (!word) return '';
            const trimmed = word.trim();
            const normalized = trimmed.replace(/^[^A-Za-z0-9\u3040-\u30ff\u3400-\u9fff]+|[^A-Za-z0-9\u3040-\u30ff\u3400-\u9fff]+$/g, '');
            return normalized;
        }

        function isJapanese(text) {
            return /[\u3040-\u30ff\u3400-\u9fff]/.test(text);
        }

        function escapeHtml(str) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return str.replace(/[&<>"']/g, c => map[c] || c);
        }

        function formatTime(sec) {
            if (sec === undefined || sec === null || Number.isNaN(sec)) return '';
            const s = Math.max(0, Math.floor(sec));
            const m = Math.floor(s / 60);
            const r = s % 60;
            return `${m}:${r.toString().padStart(2, '0')}`;
        }

        function getEjMeaning(word) {
            if (!ejDict || !word) return '';
            const keys = [word, word.toLowerCase()];
            for (const k of keys) {
                const val = ejDict[k];
                if (!val) continue;
                if (Array.isArray(val)) return val.join(' / ');
                if (typeof val === 'object') {
                    if (val.meaning) return val.meaning;
                    if (val.gloss) return val.gloss;
                }
                return String(val);
            }
            return '';
        }

        function getJaMeaningFromMap(word) {
            if (!jaDict || !word) return '';
            const entries = jaDict.get(word);
            if (!entries || !entries.length) return '';
            const showEntries = entries.slice(0, 2);
            const parts = showEntries.map(e => {
                const pos = e.pos_title || e.pos || '';
                const glosses = Array.isArray(e.senses) && e.senses.length && Array.isArray(e.senses[0].glosses)
                    ? e.senses[0].glosses.join('„ÄÅ')
                    : '';
                return `${pos ? '„Äê' + pos + '„Äë' : ''}${glosses}`;
            }).filter(Boolean);
            return parts.join('<br>');
        }

        function getPhonetic(word) {
            if (!word) return '';
            if (ejDict) {
                const keys = [word, word.toLowerCase()];
                for (const k of keys) {
                    const val = ejDict[k];
                    if (val && typeof val === 'object') {
                        if (val.phonetic) return String(val.phonetic);
                        if (val.pron) return String(val.pron);
                    }
                }
            }
            if (jaDict && jaDict.has(word)) {
                const entries = jaDict.get(word);
                for (const e of entries) {
                    if (e.phonetic) return String(e.phonetic);
                    if (e.pron) return String(e.pron);
                    if (e.reading) return String(e.reading);
                }
            }
            return '';
        }

        async function fetchDefinition(word) {
            const query = normalizeWord(word);
            if (!query) {
                const fallback = `<strong>${word}</strong><br><span style="color:#aaa">ÂçòË™û„ÅåÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</span>`;
                return fallback;
            }
            if (dictCache.has(query)) return dictCache.get(query);
            let resultHtml;
            try {
                if (isJapanese(query)) {
                    if (jaDict && jaDict.has(query)) {
                        const entries = jaDict.get(query);
                        const jaEntries = entries.filter(e => e.lang_code === 'ja');
                        const showEntries = (jaEntries.length ? jaEntries : entries).slice(0, 2);
                        const parts = showEntries.map(e => {
                            const pos = e.pos_title || e.pos || '';
                            const glosses = Array.isArray(e.senses) && e.senses.length && Array.isArray(e.senses[0].glosses)
                                ? e.senses[0].glosses.join('„ÄÅ')
                                : '';
                            return `${pos ? '„Äê' + pos + '„Äë' : ''}${glosses}`;
                        }).filter(Boolean);
                        if (parts.length) {
                            resultHtml = `<strong>${query}</strong><br>${parts.join('<br>')}`;
                        }
                    }
                } else {
                    const ejJa = getEjMeaning(query);
                    const jaFallback = ejJa ? '' : getJaMeaningFromMap(query);
                    const phon = getPhonetic(query);
                    const phonText = phon ? ` /${escapeHtml(phon)}/` : '';
                    if (ejJa || jaFallback) {
                        const meaning = ejJa || jaFallback;
                        const rendered = jaFallback ? meaning : escapeHtml(meaning);
                        resultHtml = `<strong>${query}</strong>${phonText}<br><span style="color:#aaa">${rendered}</span>`;
                    } else {
                        resultHtml = `<strong>${query}</strong>${phonText}<br><span style="color:#aaa">„É≠„Éº„Ç´„É´ËæûÊõ∏„Å´Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</span>`;
                    }
                }
            } catch (e) {}
            if (!resultHtml) {
                resultHtml = `<strong>${query}</strong><br><span style="color:#aaa">ÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</span>`;
            }
            dictCache.set(query, resultHtml);
            return resultHtml;
        }

        function toggleStudyMark(word, start) {
            const key = normalizeWord(word);
            const existing = studyList[key];
            if (existing) {
                delete studyList[key];
            } else {
                studyList[key] = {
                    word,
                    // start„ÅåÊï∞ÂÄ§„Å®„Åó„Å¶ÊúâÂäπ„ÅãÁ¢∫Ë™ç
                    start: typeof start === 'number' && !Number.isNaN(start) ? start : null,
                    timestamp: Date.now()
                };
            }
            localStorage.setItem(studyListStorage, JSON.stringify(studyList));
            updateStudyListUI();
            updateMarkButtons();
        }

        function updateStudyListUI() {
            const content = document.getElementById('study-list-content');
            const items = Object.entries(studyList).sort((a, b) => b[1].timestamp - a[1].timestamp);
            content.innerHTML = items.map(([key, data]) => {
                const t = typeof data.start === 'number' && !Number.isNaN(data.start) ? formatTime(data.start) : '';
                return `
                <div class="study-list-item" data-word="${data.word}" data-start="${data.start ?? ''}">
                    <span class="study-list-item-word">${data.word}</span>
                    <span class="study-list-item-time">${t}</span>
                </div>
                `;
            }).join('');
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            document.querySelectorAll('.study-list-item').forEach(item => {
                item.addEventListener('click', () => {
                    const s = parseFloat(item.dataset.start);
                    jumpToWord(item.dataset.word, Number.isFinite(s) ? s : undefined);
                });
                item.addEventListener('mouseenter', (ev) => {
                    showStudyItemTooltip(ev, item.dataset.word, item.dataset.start);
                });
                item.addEventListener('mouseleave', () => {
                    // Â≠¶Áøí„É™„Çπ„Éà„Åß„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇÇÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶Ê∂à„ÅôÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
                    tooltipHideTimer = setTimeout(() => {
                        dictTooltip.style.display = 'none';
                    }, 300);
                });
                // Â≠¶Áøí„É™„Çπ„ÉàÂÜÖ„Åß„ÅØ‰ΩçÁΩÆÂõ∫ÂÆö„Åß„ÇÇ„Çà„ÅÑ„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅËøΩÂæì„Åï„Åõ„Å™„ÅÑÊñπ„Åå‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ
            });
        }

        // ÂçòË™û„Å´„Ç∏„É£„É≥„ÉóÔºà‰øÆÊ≠£ÔºöÂãïÁîªÂÜçÁîü‰ΩçÁΩÆ„ÇÇÁßªÂãï„Åï„Åõ„ÇãÔºâ
        function jumpToWord(word, start) {
            const wordElements = Array.from(document.querySelectorAll('.word'));
            let target = null;
            
            // ÊôÇÂàª„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÂãïÁîª„ÅÆÂÜçÁîü‰ΩçÁΩÆ„ÇíÁßªÂãï
            if (typeof start === 'number' && !Number.isNaN(start)) {
                player.currentTime = start; // ‚òÖ„Äê‰øÆÊ≠£ÁÇπ„ÄëÂãïÁîª„Çí„Ç∑„Éº„ÇØ„Åô„Çã
                // ÊôÇÈñì„ÅßË¶ÅÁ¥†„ÇíÊ§úÁ¥¢
                target = wordElements.find(el => Math.abs(parseFloat(el.dataset.start) - start) < 0.001);
            }
            
            if (!target) {
                target = wordElements.find(el => el.innerText === word);
            }
            
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.classList.add('active');
                setTimeout(() => target.classList.remove('active'), 1000);
            }
        }

        // Â≠¶Áøí„É™„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Éõ„Éê„Éº„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
        async function showStudyItemTooltip(ev, word, start) {
            if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
            dictTooltip.style.display = 'block';
            dictTooltip.innerHTML = 'Ê§úÁ¥¢‰∏≠‚Ä¶';
            positionTooltip(ev);
            const html = await fetchDefinition(word);
            const key = normalizeWord(word);
            const isMarked = !!studyList[key];
            const markBtn = `<button class="study-mark-btn ${isMarked ? 'marked' : ''}" data-word="${word}" data-start="${start ?? ''}" title="Â≠¶Áøí„Åã„ÇâÂâäÈô§">‚òÖ</button>`;
            const speakBtn = !isJapanese(word) ? `<button class="speaker-btn" data-word="${word}" title="Áô∫Èü≥„ÇíËÅû„Åè">üîä</button>` : '';
            
            dictTooltip.innerHTML = html;
            const btnHtml = `<div class="dict-tooltip-buttons">${speakBtn}${markBtn}</div>`;
            dictTooltip.innerHTML += btnHtml;
            positionTooltip(ev);
        }

        function updateMarkButtons() {
            document.querySelectorAll('.study-mark-btn').forEach(btn => {
                const word = btn.dataset.word;
                const key = normalizeWord(word);
                btn.classList.toggle('marked', !!studyList[key]);
            });
        }

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆÁîªÈù¢Á´ØÂØæÂøú
        function positionTooltip(ev) {
            const margin = 12;
            let x = ev.clientX + margin;
            let y = ev.clientY + margin;
            
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const tooltipW = dictTooltip.offsetWidth || 340;
            const tooltipH = dictTooltip.offsetHeight || 200;
            
            if (x + tooltipW > vw) {
                x = Math.max(10, ev.clientX - tooltipW - margin);
            }
            if (y + tooltipH > vh) {
                y = Math.max(10, ev.clientY - tooltipH - margin);
            }
            
            dictTooltip.style.left = x + 'px';
            dictTooltip.style.top = y + 'px';
        }

        // Ê§úÁ¥¢Ê©üËÉΩ
        function clearSearchHighlight() {
            searchHighlightedWords.forEach(el => el.classList.remove('search-highlight'));
            searchHighlightedWords = [];
        }

        function performSearch(query) {
            currentSearchQuery = query.toLowerCase();
            clearSearchHighlight();
            
            if (!currentSearchQuery) return;
            
            const allWords = document.querySelectorAll('.word');
            allWords.forEach(el => {
                if (el.innerText.toLowerCase().includes(currentSearchQuery)) {
                    el.classList.add('search-highlight');
                    searchHighlightedWords.push(el);
                }
            });
        }

        searchBox.addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        async function loadEJDict() {
            const candidates = ['../../dictionary/ejdict.json', '../../dictionaries/ejdict.json', '../../ejdict.json'];
            for (const p of candidates) {
                try {
                    const resp = await fetch(p, { cache: 'no-cache' });
                    if (resp.ok) {
                        ejDict = await resp.json();
                        break;
                    }
                } catch (e) {
                }
            }
        }

        async function loadJaExtractDict() {
            const candidates = ['../../dictionary/ja-extract.jsonl', '../../dictionaries/ja-extract.jsonl', '../../ja-extract.jsonl'];
            for (const p of candidates) {
                try {
                    const resp = await fetch(p, { cache: 'no-cache' });
                    if (resp.ok) {
                        const text = await resp.text();
                        const map = new Map();
                        const lines = text.split(/\r?\n/).filter(Boolean);
                        for (const line of lines) {
                            try {
                                const obj = JSON.parse(line);
                                if (!obj || !obj.word) continue;
                                const key = obj.word.trim();
                                const arr = map.get(key) || [];
                                arr.push(obj);
                                map.set(key, arr);
                            } catch (e) { }
                        }
                        jaDict = map;
                        break;
                    }
                } catch (e) { }
            }
        }
        
        // --- „É™„Çµ„Ç§„Ç∫Ê©üËÉΩ ---
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('video-container');

        resizer.addEventListener('mousedown', function(e) {
            e.preventDefault();
            document.body.classList.add('resizing');
            resizer.classList.add('active');

            const startX = e.clientX;
            const startWidth = leftPanel.getBoundingClientRect().width;

            const doDrag = function(e) {
                const newWidth = startWidth + (e.clientX - startX);
                leftPanel.style.flex = `0 0 ${newWidth}px`;
            };

            const stopDrag = function() {
                document.body.classList.remove('resizing');
                resizer.classList.remove('active');
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
            };

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        });
        // --- „É™„Çµ„Ç§„Ç∫Ê©üËÉΩÁµÇ‰∫Ü ---

        // Â≠¶Áøí„É™„Çπ„Éà„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫
        document.getElementById('study-list-toggle').addEventListener('click', () => {
            document.getElementById('study-list-panel').classList.toggle('show');
        });

        document.getElementById('study-list-clear').addEventListener('click', () => {
            if (confirm('Â≠¶Áøí„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                studyList = {};
                localStorage.removeItem(studyListStorage);
                updateStudyListUI();
                updateMarkButtons();
            }
        });

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÂÜÖ„ÅÆ„Ç§„Éô„É≥„ÉàÂßîË≠≤
        dictTooltip.addEventListener('click', (e) => {
            if (e.target.classList.contains('study-mark-btn')) {
                const word = e.target.dataset.word;
                const s = parseFloat(e.target.dataset.start);
                toggleStudyMark(word, Number.isFinite(s) ? s : undefined);
            }
            if (e.target.classList.contains('speaker-btn')) {
                const word = e.target.dataset.word;
                speakWord(word);
            }
        });

        // ‚òÖ„Äê‰øÆÊ≠£ÁÇπ„Äë„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóËá™‰Ωì„ÅÆ„Éõ„Éê„Éº„Ç§„Éô„É≥„Éà
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å´‰πó„Å£„Å¶„ÅÑ„ÇãÈñì„ÅØÊ∂à„Åï„Å™„ÅÑ
        dictTooltip.addEventListener('mouseenter', () => {
            if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
        });
        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Åã„ÇâÂá∫„Åü„ÇâÊ∂à„Åô
        dictTooltip.addEventListener('mouseleave', () => {
            dictTooltip.style.display = 'none';
        });

        // 1. ÂàùÊúüÂåñÂá¶ÁêÜ
        function init() {
            if (typeof MEDIA_DATA === 'undefined') {
                console.error('MEDIA_DATA not found. ensure data.js is loaded.');
                return;
            }

            player.src = MEDIA_DATA.videoFile;

            MEDIA_DATA.segments.forEach((segment, segIndex) => {
                const segDiv = document.createElement('div');
                segDiv.className = 'segment';
                
                segment.words.forEach((w, wordIndex) => {
                    const span = document.createElement('span');
                    span.className = 'word';
                    span.innerText = w.word;
                    span.dataset.start = w.start;
                    span.dataset.end = w.end;
                    span.dataset.segIndex = segIndex;
                    span.dataset.wordIndex = wordIndex;
                    
                    let isClicking = false;
                    span.onclick = (e) => {
                        e.stopPropagation();
                        isClicking = true;
                        player.currentTime = parseFloat(span.dataset.start);
                        player.play();
                        setTimeout(() => { isClicking = false; }, 50);
                    };

                    span.addEventListener('mouseenter', (ev) => {
                        if (isClicking) return;
                        
                        // „Éû„Ç¶„Çπ„ÅåÂÖ•„Å£„Åü„ÅÆ„Åß„ÄåÈö†„Åô„Çø„Ç§„Éû„Éº„Äç„Åå„ÅÇ„Çå„Å∞„Ç≠„É£„É≥„Çª„É´
                        if (tooltipHideTimer) clearTimeout(tooltipHideTimer);

                        resumeAfterHover = !player.paused && !player.ended;
                        player.pause();
                        
                        dictTooltip.style.display = 'block';
                        dictTooltip.innerHTML = 'Ê§úÁ¥¢‰∏≠‚Ä¶';
                        positionTooltip(ev); // „Åì„Åì„Åß‰ΩçÁΩÆ„ÇíÊ±∫„ÇÅ„ÇãÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
                        
                        pendingWord = w.word;
                        if (hoverDebounceTimer) { clearTimeout(hoverDebounceTimer); }
                        hoverDebounceTimer = setTimeout(async () => {
                            const html = await fetchDefinition(w.word);
                            const key = normalizeWord(w.word);
                            const isMarked = !!studyList[key];
                            const markBtn = `<button class="study-mark-btn ${isMarked ? 'marked' : ''}" data-word="${w.word}" data-start="${w.start}" title="Â≠¶Áøí„Å´ËøΩÂä†">${isMarked ? '‚òÖ' : '‚òÜ'}</button>`;
                            const speakBtn = !isJapanese(w.word) ? `<button class="speaker-btn" data-word="${w.word}" title="Áô∫Èü≥„ÇíËÅû„Åè">üîä</button>` : '';
                            
                            if (dictTooltip.style.display === 'block' && pendingWord === w.word) {
                                dictTooltip.innerHTML = html;
                                const btnHtml = `<div class="dict-tooltip-buttons">${speakBtn}${markBtn}</div>`;
                                dictTooltip.innerHTML += btnHtml;
                                // ÂÜÖÂÆπ„ÅåÂ§â„Çè„Å£„Å¶„Çµ„Ç§„Ç∫„ÅåÂ§â„Çè„Å£„Åü„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÅÆ„ÅßÂÜçÈÖçÁΩÆ
                                positionTooltip(ev); 
                            }
                        }, 150);
                    });

                    // ‚òÖ„Äê‰øÆÊ≠£ÁÇπ„Äëmousemove„Ç§„Éô„É≥„Éà„ÇíÂâäÈô§ („Ç´„Éº„ÇΩ„É´ËøΩÂæì„ÇíÂªÉÊ≠¢„Åó„ÄÅ‰ΩçÁΩÆ„ÇíÂõ∫ÂÆöÂåñ)
                    /*
                    span.addEventListener('mousemove', (ev) => {
                        if (dictTooltip.style.display === 'block') {
                            positionTooltip(ev);
                        }
                    });
                    */

                    span.addEventListener('mouseleave', () => {
                        if (hoverDebounceTimer) { clearTimeout(hoverDebounceTimer); hoverDebounceTimer = null; }
                        pendingWord = null;
                        if (resumeAfterHover) {
                            player.play();
                        }
                        resumeAfterHover = false;
                        
                        // ‚òÖ„Äê‰øÆÊ≠£ÁÇπ„ÄëÂç≥Â∫ß„Å´Ê∂à„Åï„Åö„ÄÅÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÊ∂à„Åô („ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å∏„ÅÆÁßªÂãïÁå∂‰∫à)
                        tooltipHideTimer = setTimeout(() => {
                            dictTooltip.style.display = 'none';
                        }, 300);
                    });
                    
                    segDiv.appendChild(span);
                });

                const transDiv = document.createElement('span');
                transDiv.className = 'translation';
                transDiv.innerText = segment.translation;
                segDiv.appendChild(transDiv);

                contentDiv.appendChild(segDiv);
            });
        }

        // 2. ÂêåÊúü„É≠„Ç∏„ÉÉ„ÇØ
        let allWords = []; 

        function cacheWords() {
            allWords = Array.from(document.querySelectorAll('.word')).map(el => ({
                el: el,
                start: parseFloat(el.dataset.start),
                end: parseFloat(el.dataset.end)
            }));
        }

        function updateHighlight() {
            const currentTime = player.currentTime;

            for (let i = 0; i < allWords.length; i++) {
                const w = allWords[i];
                if (currentTime >= w.start && currentTime < w.end) {
                    if (!w.el.classList.contains('active')) {
                        w.el.classList.add('active');
                        w.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    if (w.el.classList.contains('active')) {
                        w.el.classList.remove('active');
                    }
                }
            }
            requestAnimationFrame(updateHighlight);
        }

        // ÂÆüË°åÈñãÂßã
        document.addEventListener('DOMContentLoaded', async () => {
            usePreloadedDictsIfAny();
            if (!ejDict || !jaDict) {
                if (canLoadLocalDict) {
                    await loadEJDict();
                    await loadJaExtractDict();
                }
            }
            init();
            cacheWords();
            updateStudyListUI();
            requestAnimationFrame(updateHighlight);
        });

    </script>
</body>
</html>