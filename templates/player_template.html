<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Language Player (PiP Audio Fixed)</title>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #fff; }
        #video-container { flex: 0 0 75%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        video { max-width: 100%; max-height: 100%; }
        #error-message { display: none; color: #ff5555; background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid #ff5555; border-radius: 8px; text-align: center; z-index: 100; position: absolute; }
        #resizer { width: 8px; background: #333; cursor: col-resize; transition: background 0.2s; z-index: 10; }
        #resizer:hover, #resizer.active { background: #00FFFF; }
        #transcript-container { flex: 1; overflow-y: auto; padding: 8px; box-sizing: border-box; border-left: none; min-width: 200px; font-size: 0.95em; }
        body.resizing { cursor: col-resize; user-select: none; }
        .segment { margin-bottom: 8px; padding: 4px; border-radius: 8px; transition: background 0.2s; }
        .segment:hover { background: #2a2a2a; }
        .word { cursor: pointer; padding: 0px 2px; border-radius: 4px; transition: all 0.1s; margin-right: 1px; display: inline-block; line-height: 1.15; }
        .word:hover { background: #444; }
        .word.active { background: #00FFFF; color: #000; font-weight: inherit; }
        .translation { display: block; margin-top: 3px; color: #aaa; font-size: 0.8em; line-height: 1.25; border-left: 2px solid #555; padding-left: 5px; }
        
        /* ËæûÊõ∏„ÉªÊ§úÁ¥¢Áî®„ÅÆCSS */
        .dict-tooltip { position: fixed; max-width: 320px; background: #111; color: #fff; border: 1px solid #444; border-radius: 6px; padding: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.5); font-size: 0.9em; line-height: 1.4; z-index: 1000; pointer-events: auto; max-height: 60vh; overflow-y: auto; }
        .dict-header { display: flex; align-items: baseline; gap: 8px; border-bottom: 1px solid #333; padding-bottom: 6px; margin-bottom: 6px; }
        .dict-word { font-weight: bold; font-size: 1.1em; color: #fff; }
        .dict-phonetic { color: #888; font-family: 'Segoe UI Symbol', sans-serif; }
        .dict-meaning-group { margin-bottom: 8px; }
        .dict-pos { display: inline-block; background: #333; color: #00FFFF; padding: 1px 4px; border-radius: 3px; font-size: 0.75em; margin-right: 6px; border: 1px solid #444; }
        .dict-def { color: #ddd; font-size: 0.9em; display: inline; }
        .speaker-btn { background: none; border: none; cursor: pointer; color: #00FFFF; font-size: 1em; padding: 0 4px; }
        .speaker-btn:hover { color: #fff; }

        #search-box { position: fixed; top: 10px; right: 10px; width: 125px; padding: 8px 12px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 0.9em; z-index: 999; }
        #search-box::placeholder { color: #888; }
        #search-box:focus { outline: none; border-color: #00FFFF; box-shadow: 0 0 6px rgba(0, 255, 255, 0.3); }
        .word.search-highlight { background: #FFB90C; color: #000; font-weight: bold; }

        /* PiP„Éú„Çø„É≥ */
        #pip-btn { position: fixed; top: 10px; left: 10px; z-index: 999; background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #pip-btn:hover { background: #555; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #video-container { flex: none; width: 100%; height: 40vh; border-bottom: 2px solid #333; }
            #resizer { display: none; }
            #transcript-container { width: 100%; height: 60vh; border-left: none; padding: 8px; }
            .word { padding: 3px 5px; font-size: 1.05em; margin-bottom: 3px; }
            #search-box { position: sticky; top: 0; right: auto; width: 100%; box-sizing: border-box; margin: 0 0 8px 0; }
            #pip-btn { display: none; }
        }
    </style>
</head>
<body>

    <button id="pip-btn" onclick="togglePiP()">‚ßâ PiP</button>

    <div id="video-container">
        <div id="error-message"></div>
        <video id="player" controls playsinline webkit-playsinline preload="auto"></video> 
    </div>

    <div id="resizer"></div>
    <div id="transcript-container">
        <input type="text" id="search-box" placeholder="ÂçòË™û„ÇíÊ§úÁ¥¢...">
        <div id="content"></div>
    </div>

    <script src="data.js"></script>

    <div id="dict-tooltip" class="dict-tooltip" style="display:none;"></div>
    
    <script>
        const player = document.getElementById('player');
        const contentDiv = document.getElementById('content');
        const errorMsgDiv = document.getElementById('error-message');
        const dictTooltip = document.getElementById('dict-tooltip');
        const searchBox = document.getElementById('search-box');
        
        let resumeAfterHover = false;
        let hoverActiveCount = 0;
        let hoverDebounceTimer = null;
        let tooltipHideTimer = null;
        let pendingWord = null;
        let dictCache = new Map();
        let allWords = [];

        // --- Èü≥Â£∞ÂÜçÁîüÊ©üËÉΩ ---
        async function speakWord(text) {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- PiPÊ©üËÉΩ (Document Picture-in-Picture) ---
        async function togglePiP() {
            if (!window.documentPictureInPicture) {
                alert("„Åì„ÅÆÊ©üËÉΩ„ÅØDocument Picture-in-Picture API„Å´ÂØæÂøú„Åó„Åü„Éñ„É©„Ç¶„Ç∂ÔºàChrome, Edge v111‰ª•Èôç„Å™„Å©Ôºâ„Åß„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ");
                return;
            }

            if (window.documentPictureInPicture.window) {
                window.documentPictureInPicture.window.close();
                return;
            }

            try {
                const pipWindow = await window.documentPictureInPicture.requestWindow({
                    width: 800,
                    height: 600
                });

                // „ÄêÈáçË¶Å„ÄëPiP„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´Èü≥Â£∞ÂÜçÁîüÈñ¢Êï∞„ÇíÊ∏°„ÅôÔºà„Åì„Çå„ÅåÁÑ°„ÅÑ„Å®Èü≥„ÅåÈ≥¥„Çä„Åæ„Åõ„ÇìÔºâ
                pipWindow.speakWord = speakWord;

                // „Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà„Çí„Ç≥„Éî„Éº
                [...document.styleSheets].forEach((styleSheet) => {
                    try {
                        const cssRules = [...styleSheet.cssRules].map((rule) => rule.cssText).join('');
                        const style = document.createElement('style');
                        style.textContent = cssRules;
                        pipWindow.document.head.appendChild(style);
                    } catch (e) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.type = styleSheet.type;
                        link.media = styleSheet.media;
                        link.href = styleSheet.href;
                        pipWindow.document.head.appendChild(link);
                    }
                });

                const videoContainer = document.getElementById('video-container');
                const transcriptContainer = document.getElementById('transcript-container');
                const resizer = document.getElementById('resizer');
                const tooltip = document.getElementById('dict-tooltip');
                const pipBtn = document.getElementById('pip-btn');

                pipWindow.document.body.append(videoContainer);
                pipWindow.document.body.append(transcriptContainer);
                pipWindow.document.body.append(tooltip);
                
                pipWindow.document.body.style.display = 'flex';
                pipWindow.document.body.style.flexDirection = 'column';
                videoContainer.style.flex = '0 0 50%';
                transcriptContainer.style.flex = '1';
                
                resizer.style.display = 'none';
                pipBtn.innerText = "‚ßâ Èñâ„Åò„Çã";

                pipWindow.addEventListener('pagehide', (event) => {
                    const originalBody = document.body;
                    resizer.style.display = 'block';
                    resizer.parentNode.insertBefore(videoContainer, resizer);
                    resizer.after(transcriptContainer);
                    originalBody.appendChild(tooltip);

                    videoContainer.style.flex = '0 0 75%';
                    videoContainer.style.height = '';
                    transcriptContainer.style.flex = '1';
                    
                    pipBtn.innerText = "‚ßâ PiP";
                });

            } catch (err) {
                console.error("PiP Error:", err);
            }
        }

        // --- ËæûÊõ∏Ê©üËÉΩ (APIÁâà) ---
        function normalizeWord(word) {
            if (!word) return '';
            return word.trim().replace(/^[^A-Za-z0-9]+|[^A-Za-z0-9]+$/g, '');
        }

        async function fetchDefinition(word) {
            const query = normalizeWord(word);
            if (!query) return `<div class="dict-header"><span class="dict-word">${word}</span></div><span style="color:#aaa">Ê§úÁ¥¢‰∏çÂèØ</span>`;
            
            if (dictCache.has(query)) return dictCache.get(query);
            
            try {
                const resp = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(query)}`);
                if (!resp.ok) throw new Error('Not found');
                const json = await resp.json();
                const entry = json[0];

                let html = `<div class="dict-header">`;
                html += `<span class="dict-word">${entry.word}</span>`;
                if (entry.phonetic) html += `<span class="dict-phonetic">${entry.phonetic}</span>`;
                html += `<button class="speaker-btn" onclick="speakWord('${entry.word.replace(/'/g, "\\'")}')">üîä</button>`;
                html += `</div>`;

                const meaningsToShow = entry.meanings.slice(0, 3);
                if (meaningsToShow.length === 0) {
                    html += `<div style="color:#aaa">ÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>`;
                } else {
                    meaningsToShow.forEach(m => {
                        const def = m.definitions && m.definitions.length > 0 ? m.definitions[0].definition : '';
                        if (def) {
                            html += `<div class="dict-meaning-group">`;
                            html += `<span class="dict-pos">${m.partOfSpeech}</span>`;
                            html += `<span class="dict-def">${def}</span>`;
                            html += `</div>`;
                        }
                    });
                }
                dictCache.set(query, html);
                return html;
            } catch (e) {
                const errorHtml = `<div class="dict-header"><span class="dict-word">${query}</span></div><span style="color:#aaa">ËæûÊõ∏ÂÆöÁæ©„Å™„Åó</span>`;
                dictCache.set(query, errorHtml);
                return errorHtml;
            }
        }

        // --- „Ç∑„Éº„ÇØÊ©üËÉΩ ---
        function safeSeek(time) {
            if (!Number.isFinite(time)) return;
            let seekable = false;
            if (player.seekable && player.seekable.length > 0) {
                for (let i = 0; i < player.seekable.length; i++) {
                    if (time >= player.seekable.start(i) && time <= player.seekable.end(i)) {
                        seekable = true;
                        break;
                    }
                }
            } else { seekable = true; }

            if (seekable) {
                if (player.fastSeek) player.fastSeek(time);
                else player.currentTime = time;
                if (player.paused) player.play().catch(e => console.log('Autoplay blocked:', e));
            } else {
                errorMsgDiv.innerText = "Ë™≠„ÅøËæº„ÅøÂæÖ„Å°„Åß„Åô„ÄÇ";
                errorMsgDiv.style.display = 'block';
                setTimeout(() => errorMsgDiv.style.display = 'none', 3000);
            }
        }

        // --- ÂàùÊúüÂåñ ---
        function init() {
            if (typeof MEDIA_DATA === 'undefined') {
                errorMsgDiv.innerHTML = 'data.js „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
                errorMsgDiv.style.display = 'block';
                return;
            }

            player.src = MEDIA_DATA.videoFile;

            MEDIA_DATA.segments.forEach((segment) => {
                const segDiv = document.createElement('div');
                segDiv.className = 'segment';
                
                segment.words.forEach((w) => {
                    const span = document.createElement('span');
                    span.className = 'word';
                    span.innerText = w.word;
                    span.dataset.start = w.start;
                    span.dataset.end = w.end;
                    
                    let isClicking = false;
                    
                    span.onclick = (e) => {
                        e.stopPropagation();
                        isClicking = true;
                        const startTime = parseFloat(span.dataset.start);
                        safeSeek(startTime);
                        setTimeout(() => { isClicking = false; }, 200);
                    };

                    span.addEventListener('mouseenter', (ev) => {
                        if (isClicking) return;
                        if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
                        
                        if (hoverActiveCount === 0) resumeAfterHover = !player.paused && !player.ended;
                        hoverActiveCount++;
                        if (!player.paused && !player.ended) player.pause();

                        dictTooltip.style.display = 'block';
                        dictTooltip.innerHTML = '<div class="dict-header"><span class="dict-word">Loading...</span></div>';
                        positionTooltip(ev);
                        pendingWord = w.word;

                        if (hoverDebounceTimer) clearTimeout(hoverDebounceTimer);
                        
                        hoverDebounceTimer = setTimeout(async () => {
                            const html = await fetchDefinition(w.word);
                            if (dictTooltip.style.display === 'block' && pendingWord === w.word) {
                                dictTooltip.innerHTML = html;
                                positionTooltip(ev);
                            }
                        }, 150);
                    });

                    span.addEventListener('mouseleave', () => {
                        if (hoverDebounceTimer) clearTimeout(hoverDebounceTimer);
                        pendingWord = null;
                        hoverActiveCount = Math.max(0, hoverActiveCount - 1);
                        if (hoverActiveCount === 0) {
                            if (resumeAfterHover) player.play().catch(()=>{});
                            resumeAfterHover = false;
                            tooltipHideTimer = setTimeout(() => dictTooltip.style.display = 'none', 300);
                        }
                    });
                    
                    segDiv.appendChild(span);
                });
                
                const trans = document.createElement('span');
                trans.className = 'translation';
                trans.innerText = segment.translation;
                segDiv.appendChild(trans);
                contentDiv.appendChild(segDiv);
            });
        }

        async function attemptAutoplay() {
            try { await player.play(); } catch (e) {
                try { player.muted = true; await player.play(); } catch (e2) {}
            }
        }

        // --- „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó‰ΩçÁΩÆË®àÁÆó ---
        function positionTooltip(ev) {
            const margin = 12;
            const currentWindow = ev.view || window;
            
            let x = ev.clientX + margin;
            let y = ev.clientY + margin;
            
            const vw = currentWindow.innerWidth;
            const vh = currentWindow.innerHeight;
            const tooltipW = dictTooltip.offsetWidth || 320;
            const tooltipH = dictTooltip.offsetHeight || 150;

            if (x + tooltipW > vw) x = Math.max(10, ev.clientX - tooltipW - margin);
            if (y + tooltipH > vh) y = Math.max(10, ev.clientY - tooltipH - margin);

            dictTooltip.style.left = x + 'px';
            dictTooltip.style.top = y + 'px';
        }

        dictTooltip.addEventListener('mouseenter', () => {
            if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
            if (hoverActiveCount === 0) resumeAfterHover = !player.paused && !player.ended;
            hoverActiveCount++;
            if (!player.paused && !player.ended) player.pause();
        });
        dictTooltip.addEventListener('mouseleave', () => {
            hoverActiveCount = Math.max(0, hoverActiveCount - 1);
            if (hoverActiveCount === 0) {
                if (resumeAfterHover) player.play().catch(()=>{});
                resumeAfterHover = false;
                dictTooltip.style.display = 'none';
            }
        });

        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('video-container');
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.body.classList.add('resizing');
            resizer.classList.add('active');
            const startX = e.clientX;
            const startWidth = leftPanel.getBoundingClientRect().width;
            const doDrag = (e) => { leftPanel.style.flex = `0 0 ${startWidth + (e.clientX - startX)}px`; };
            const stopDrag = () => {
                document.body.classList.remove('resizing');
                resizer.classList.remove('active');
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
            };
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        });

        function cacheWords() {
            allWords = Array.from(document.querySelectorAll('.word')).map(el => ({
                el: el, start: parseFloat(el.dataset.start), end: parseFloat(el.dataset.end)
            }));
        }

        function updateHighlight() {
            const currentTime = player.currentTime;
            for (const w of allWords) {
                if (currentTime >= w.start && currentTime < w.end) {
                    if (!w.el.classList.contains('active')) {
                        w.el.classList.add('active');
                        w.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    if (w.el.classList.contains('active')) w.el.classList.remove('active');
                }
            }
            requestAnimationFrame(updateHighlight);
        }

        searchBox.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            allWords.forEach(w => {
                if (val && w.el.innerText.toLowerCase().includes(val)) {
                    w.el.classList.add('search-highlight');
                } else {
                    w.el.classList.remove('search-highlight');
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            init();
            attemptAutoplay();
            cacheWords();
            requestAnimationFrame(updateHighlight);
        });
    </script>
</body>
</html>